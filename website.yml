workflows:
  build-test-push-workflow:
    jobs:
      - build:
          name: build-latest
          tag: latest
          environment: staging
          filters:
            branches:
              ignore: main
          context:
            - aws
      - build:
          name: build-staging
          tag: staging
          environment: staging
          filters:
            branches:
              only: main
          context:
            - aws
      - deploy:
          name: deploy-staging-<< matrix.region >>
          environment: staging
          requires:
            - build-staging
          matrix:
            parameters:
              region:
                - use1
                - use2
                - usw1
                - usw2
          context:
            - terraform
          filters:
            branches:
              only: main
            tags:
              only: ""
  release-workflow:
    jobs:
      - build:
          name: build-production
          tag: production
          environment: production
          context:
            - aws
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
      - deploy:
          name: deploy-production-<< matrix.region >>
          environment: production
          requires:
            - build-production
          context:
            - terraform
          matrix:
            parameters:
              region:
                - use1
                - use2
                - usw1
                - usw2
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
