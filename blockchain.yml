workflows:
  build-test-push-workflow:
    jobs:
      - build:
          name: build-latest
          tag: latest
          environment: testnet
          filters:
            branches:
              ignore: main
          context:
            - aws
      - build:
          name: build-testnet
          tag: testnet
          environment: testnet
          filters:
            branches:
              only: main
          context:
            - aws
      - deploy:
          name: deploy-testnet-<< matrix.region >>
          environment: testnet
          requires:
            - build-testnet
          matrix:
            parameters:
              region:
                - use1
                - use2
                - usw1
                - usw2
          context:
            - terraform
          filters:
            branches:
              only: main
            tags:
              only: ""
  release-workflow:
    jobs:
      - build:
          name: build-mainnet
          tag: mainnet
          environment: mainnet
          context:
            - aws
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
      - deploy:
          name: deploy-mainnet-<< matrix.region >>
          environment: mainnet
          requires:
            - build-mainnet
          context:
            - terraform
          matrix:
            parameters:
              region:
                - use1
                - use2
                - usw1
                - usw2
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
